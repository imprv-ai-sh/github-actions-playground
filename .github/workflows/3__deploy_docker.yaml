name: Deploy Docker Application

# Manual deployment workflow that takes a Docker tag as input
on:
  workflow_dispatch:
    inputs:
      docker_tag:
        description: 'Docker image tag to deploy (e.g., abc123f, v1.2.3)'
        required: true
        default: 'latest'
      environment:
        description: 'Target environment (development, production)'
        required: true
        default: 'development'

jobs:
  # First job: Deploy to Development Environment
  deploy-development:
    runs-on: ubuntu-latest
    if: inputs.environment == 'development'
    environment: 
      name: development
      url: https://dev.masterclass-app.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate Docker tag
        run: |
          echo "Validating Docker tag: ${{ inputs.docker_tag }}"
          if [[ -z "${{ inputs.docker_tag }}" ]]; then
            echo "Error: Docker tag cannot be empty"
            exit 1
          fi
          echo "âœ… Docker tag validation passed"
      
      - name: Simulate pre-deployment checks
        run: |
          echo "ğŸ” Running pre-deployment health checks..."
          sleep 2
          echo "âœ… Database connectivity: OK"
          echo "âœ… External services: OK" 
          echo "âœ… Configuration validation: OK"
      
      - name: Simulate Docker image pull
        run: |
          echo "ğŸ“¦ Pulling Docker image: registry.digitalocean.com/masterclass-registry/test-image:${{ inputs.docker_tag }}"
          sleep 3
          echo "âœ… Image pulled successfully"
      
      - name: Deploy to Development Environment
        run: |
          echo "ğŸš€ Deploying to Development Environment..."
          echo "Environment: development"
          echo "Docker Tag: ${{ inputs.docker_tag }}"
          echo "Deployment URL: https://dev.masterclass-app.com"
          
          # Simulate deployment process
          sleep 5
          
          echo "âœ… Application deployed successfully to development!"
          echo "ğŸŒ Available at: https://dev.masterclass-app.com" 

  # Second job: Deploy to Production Environment
  deploy-production:
    runs-on: ubuntu-latest
    if: inputs.environment == 'production'
    environment:
      name: production
      url: https://masterclass-app.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
       
      - name: Pre-production validation
        run: |
          echo "ğŸ”’ Running production readiness checks..."
          echo "Docker Tag: ${{ inputs.docker_tag }}"
          sleep 2
      
      - name: Simulate Docker image pull (Production)
        run: |
          echo "ğŸ“¦ Pulling Docker image for production: registry.digitalocean.com/masterclass-registry/test-image:${{ inputs.docker_tag }}"
          sleep 2
          echo "âœ… Production image pulled and verified"
      
      - name: Deploy to Production Environment
        run: |
          echo "ğŸš€ Deploying to Production Environment..."
          echo "Environment: production"
          echo "Docker Tag: ${{ inputs.docker_tag }}"
          echo "Deployment URL: https://masterclass-app.com"
          
          echo "âœ… Production deployment completed successfully!"
          echo "ğŸŒ Live at: https://masterclass-app.com"
      
      
      - name: Notify team
        run: |
          echo "ğŸ“¢ Deployment Notification"
          echo "ğŸ‰ Successfully deployed version ${{ inputs.docker_tag }} to production!"
          echo "ğŸ”— URL: https://masterclass-app.com"
          echo "ğŸ“‹ Check the deployment report for details"
